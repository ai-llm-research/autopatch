
typedef int irqreturn_t;
#define IRQ_NONE 0
#define IRQ_HANDLED 1

typedef unsigned int u32;
struct device {};
struct drm {
    struct device *dev;
};
struct dma_fence {
    int base;
};

struct v3d_dev {
    struct drm drm;
    struct {
        struct v3d_fence *fence;
    } *tfu_job;
    int va_width;
    int ver;
};

struct v3d_fence {
    int seqno;
    int base;
};

#define V3D_HUB_INT_TFU 1
#define V3D_HUB_INT_MMU 2
#define V3D_HUB_INT_STS 3
#define V3D_HUB_MMU_VIO_ID 4
#define V3D_HUB_MMU_VIO_ADDR 5
#define V3D_HUB_MMU_CTL 6
#define V3D_HUB_MMU_CTL_CLEAR 7
#define V3D_HUB_INT_CLR 8

#define V3D_READ(x) (x)
#define V3D_WRITE(x, y) do {} while (0)
#define ARRAY_SIZE(x) (sizeof(x) / sizeof((x)[0]))

static irqreturn_t v3d_hub_irq(int irq, void *arg) {
    struct v3d_dev *v3d = arg;
    u32 intsts;
    irqreturn_t status = IRQ_NONE;

    intsts = V3D_READ(V3D_HUB_INT_STS);
    V3D_WRITE(V3D_HUB_INT_CLR, intsts);

    if (intsts & V3D_HUB_INT_TFU) {
        struct v3d_fence *fence = v3d->tfu_job->fence;
        trace_v3d_tfu_irq(fence->seqno);
        dma_fence_signal(&fence->base);
        status = IRQ_HANDLED;
    }

    if (intsts & V3D_HUB_INT_MMU) {
        u32 axi_id = V3D_READ(V3D_HUB_MMU_VIO_ID);
        u32 vio_addr = V3D_READ(V3D_HUB_MMU_VIO_ADDR);
        vio_addr &= (1 << v3d->va_width) - 1;

        static const char *client_names[] = {
            "V3D_HUB_CLIENT_TFU",
            "V3D_HUB_CLIENT_CSD",
            "V3D_HUB_CLIENT_L2C",
            "V3D_HUB_CLIENT_GCA",
            "V3D_HUB_CLIENT_PTB",
            "V3D_HUB_CLIENT_CLE",
            "V3D_HUB_CLIENT_CLE1",
            "V3D_HUB_CLIENT_CLE2",
            "V3D_HUB_CLIENT_CLE3",
            "V3D_HUB_CLIENT_CLE4",
            "V3D_HUB_CLIENT_CLE5",
        };

        const char *client_name = "UNKNOWN";
        V3D_WRITE(V3D_HUB_MMU_CTL, V3D_READ(V3D_HUB_MMU_CTL) | V3D_HUB_MMU_CTL_CLEAR);

        if (v3d->ver >= 41) {
            axi_id >>= 4;
            if (axi_id < ARRAY_SIZE(client_names))
                client_name = client_names[axi_id];
        }

        dev_err(v3d->drm.dev, "MMU error from client %s at address 0x%08x\n", client_name, vio_addr);
        status = IRQ_HANDLED;
    }

    return status;
}

void trace_v3d_tfu_irq(int seqno) {}
void dma_fence_signal(int *base) {}
void dev_err(struct device *dev, const char *fmt, ...) {}
