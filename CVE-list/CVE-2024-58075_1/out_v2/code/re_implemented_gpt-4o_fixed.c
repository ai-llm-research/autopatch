

struct ahash_request;
struct crypto_ahash;
struct tegra_cmac_ctx;
struct tegra_cmac_reqctx;

struct se {
    int engine;
};

struct tegra_cmac_ctx {
    struct se* se;
};

struct tegra_cmac_reqctx {
    int task;
};

struct crypto_ahash* crypto_ahash_reqtfm(struct ahash_request* req);
struct tegra_cmac_ctx* crypto_ahash_ctx(struct crypto_ahash* tfm);
struct tegra_cmac_reqctx* ahash_request_ctx(struct ahash_request* req);
void tegra_cmac_init(struct ahash_request* req);
int crypto_transfer_hash_request_to_engine(int engine, struct ahash_request* req);

#define SHA_UPDATE 0x01
#define SHA_FINAL 0x02

static int tegra_cmac_digest(struct ahash_request* req) {
    // Retrieve the crypto_ahash transformation object from the request
    struct crypto_ahash* tfm = crypto_ahash_reqtfm(req);

    // Retrieve the tegra_cmac_ctx context from the transformation object
    struct tegra_cmac_ctx* ctx = crypto_ahash_ctx(tfm);

    // Retrieve the request context specific to tegra_cmac from the request
    struct tegra_cmac_reqctx* rctx = ahash_request_ctx(req);

    // Initialize the CMAC operation by setting up the request context
    tegra_cmac_init(req);

    // Update the task in the request context to include SHA_UPDATE and SHA_FINAL flags
    rctx->task |= SHA_UPDATE | SHA_FINAL;

    // Transfer the hash request to the crypto engine for processing
    return crypto_transfer_hash_request_to_engine(ctx->se->engine, req);
}

