```c
void usb_del_gadget(struct usb_gadget *gadget)
{
	struct usb_udc *udc = gadget->udc;

	if (!udc)
		return;

	dev_vdbg(gadget->dev.parent, "unregistering gadget\n");

	mutex_lock(&udc_lock);
	list_del(&udc->list);
	mutex_unlock(&udc_lock);

	kobject_uevent(&udc->dev.kobj, KOBJ_REMOVE);
	sysfs_remove_link(&udc->dev.kobj, "gadget");
	flush_work(&gadget->work);
	device_del(&gadget->dev);
	ida_free(&gadget_id_numbers, gadget->id_number);
	cancel_work_sync(&udc->vbus_work);
	device_unregister(&udc->dev);
}
EXPORT_SYMBOL_GPL(usb_del_gadget);
```
