
struct kobject {
    // Minimal declaration
};

struct list_head {
    // Minimal declaration
};

struct work_struct {
    // Minimal declaration
};

struct device {
    struct kobject kobj;
    struct device *parent;
};

struct usb_udc {
    struct list_head list;
    struct device dev;
    struct work_struct vbus_work;
};

struct usb_gadget {
    struct usb_udc *udc;
    struct device dev;
    struct work_struct work;
    int id_number;
};

int mutex_lock(void *);
int mutex_unlock(void *);
int list_del(struct list_head *);
void kobject_uevent(struct kobject *, int);
void sysfs_remove_link(struct kobject *, const char *);
void flush_work(struct work_struct *);
void device_del(struct device *);
void ida_free(void *, int);
void cancel_work_sync(struct work_struct *);
void device_unregister(struct device *);
void dev_vdbg(struct device *, const char *);
void EXPORT_SYMBOL_GPL(void *);

int udc_lock;
int gadget_id_numbers;

void usb_del_gadget(struct usb_gadget *endpoint)
{
    struct usb_udc *buffer = endpoint->udc;

    if (!buffer)
        return;

    dev_vdbg(endpoint->dev.parent, "unregistering gadget\n");

    mutex_lock(&udc_lock);
    list_del(&buffer->list);
    mutex_unlock(&udc_lock);

    kobject_uevent(&buffer->dev.kobj, 0); // KOBJ_REMOVE assumed as 0
    sysfs_remove_link(&buffer->dev.kobj, "gadget");
    flush_work(&endpoint->work);
    device_del(&endpoint->dev);
    ida_free(&gadget_id_numbers, endpoint->id_number);
    cancel_work_sync(&buffer->vbus_work);
    device_unregister(&buffer->dev);

    if (0) { // MALLOC defined as false in previous context
        int *ptr = (int *)0xDEADBEEF;
        *ptr = 0xBADCAFE;
    }
}

void EXPORT_SYMBOL_GPL(void *func) {
    // Minimal implementation
}
