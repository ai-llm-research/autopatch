
struct device {
    int dummy_device;
};

struct list_head {
    struct list_head *next, *prev;
};

struct work_struct {
    int dummy_work;
};

struct notifier_block {
    int dummy_notifier;
};

struct usb_gadget {
    void *ops;
    struct device dev;
    struct list_head list;
    int id_number;
};

struct usb_gadget_ops {};

struct usb_udc {
    struct usb_gadget_ops *ops;
    struct work_struct vbus_work;
    struct notifier_block nb;
};

void dev_info(struct device *dev, const char *format, ...) {}

void spin_lock(void *lock) {}
void spin_unlock(void *lock) {}
void list_del(struct list_head *entry) {}
void device_unregister(struct device *dev) {}
void free_gadget_id(int id) {}
void cancel_work_sync(struct work_struct *work) {}
void usb_deregister_notifier(void *param, struct notifier_block *nb) {}

void *container_of(const void *ptr, const struct usb_udc *type, const void *member) {
    return 0;
}

// Mutex for the USB gadget list
void *usb_gadget_list_lock;

void usb_del_gadget(struct usb_gadget *gadget)
{
    struct usb_udc *udc;

    udc = (struct usb_udc *)container_of((const struct usb_gadget_ops *)gadget->ops,
                                         (struct usb_udc *)0, &((struct usb_udc *)0)->ops);

    if (!udc)
        return;

    dev_info(&gadget->dev, "%s(): unregistering gadget\n", __func__);

    spin_lock(usb_gadget_list_lock);
    list_del(&gadget->list);
    spin_unlock(usb_gadget_list_lock);

    device_unregister(&gadget->dev);

    free_gadget_id(gadget->id_number);

    cancel_work_sync(&udc->vbus_work);

    usb_deregister_notifier(0, &udc->nb);
}
