

struct squashfs_symlink_inode {
    char *symlink;
    int symlink_size;
};

char *sqfs_get_abs_path(const char *base_path, const char *target);

void *malloc(unsigned long size);
void free(void *ptr);
void *memcpy(void *dest, const void *src, unsigned long n);

#define NULL ((void *)0)

static char *sqfs_resolve_symlink(struct squashfs_symlink_inode *sym,
                                  const char *base_path)
{
    // Declare pointers for the resolved path and target path, and a variable for size
    char *resolved = NULL;
    char *target = NULL;
    int target_size = 0;

    // Retrieve the size of the symlink target path from the inode structure
    target_size = sym->symlink_size;

    // Allocate memory for the target path, including space for a null terminator
    target = malloc(target_size + 1);

    // Check if memory allocation failed and return NULL if it did
    if (!target)
        return NULL;

    /*
     * There is no trailing null byte in the symlink's target path, so a
     * copy is made and a '\0' is added at its end.
     */
    // Copy the symlink target path from the inode to the allocated memory
    memcpy(target, sym->symlink, target_size);
    // Add a null terminator at the end of the target path
    target[target_size] = '\0';

    // Convert the relative target path to an absolute path using the base path
    resolved = sqfs_get_abs_path(base_path, target);

    // Free the memory allocated for the target path
    free(target);

    // Return the resolved absolute path
    return resolved;
}

