

typedef struct {
    unsigned int symlink_size;
    char *symlink;
} squashfs_symlink_inode;

char *sqfs_get_abs_path(const char *base_path, const char *target_path);

char *malloc(unsigned long size);
void free(void *ptr);
void *memset(void *s, int c, unsigned long n);
void *memcpy(void *dest, const void *src, unsigned long n);

#define NULL ((void*)0)

static char *sqfs_resolve_symlink(squashfs_symlink_inode *sym,
                                  const char *base_path)
{
    // Declare pointers for the resolved path and target path, and a variable for size
    char *target_path = NULL;
    char *resolved_path = NULL;
    unsigned int target_size = 0;

    // Retrieve the size of the symlink target path from the inode structure
    target_size = sym->symlink_size;

    // Allocate memory for the target path, including space for a null terminator
    target_path = malloc(target_size + 1); 

    // Check if memory allocation failed and return NULL if it did
    if (!target_path)
        goto error_out;

    /* No trailing null byte in the symlink's target path, add one */
    // Add a null terminator at the end of the target path
    memset(target_path, 0x00, target_size + 1);

    // Copy the symlink target path from the inode to the allocated memory
    memcpy(target_path, sym->symlink, target_size);

    // Convert the relative target path to an absolute path using the base path
    resolved_path = sqfs_get_abs_path(base_path, target_path);

error_out:

    // Free the memory allocated for the target path
    free(target_path);

    // Return the resolved absolute path
    return resolved_path;
}

