

typedef int irqreturn_t;
#define IRQ_NONE 0
#define IRQ_HANDLED 1

typedef unsigned int u32;

struct v3d_dev {
    struct {
        void *dev;
    } drm;
    struct {
        struct v3d_fence *irq_fence;
    } *bin_job;
    struct {
        struct v3d_fence *irq_fence;
    } *render_job;
    struct {
        struct v3d_fence *irq_fence;
    } *csd_job;
    int single_irq_line;
    void (*overflow_mem_work)(void);
};

struct v3d_fence {
    int seqno;
    struct {
        int base;
    } base;
};

unsigned V3D_CORE_READ(int a, int b) {
    return 0;
}

void V3D_CORE_WRITE(int a, int b, int c) {
}

void schedule_work(void (*work_func)(void)) {
}

struct v3d_fence* to_v3d_fence(struct v3d_fence *fence) {
    return fence;
}

void trace_v3d_bcl_irq(void *drm, int seqno) {
}

void dma_fence_signal(void *base) {
}

void trace_v3d_rcl_irq(void *drm, int seqno) {
}

void trace_v3d_csd_irq(void *drm, int seqno) {
}

void dev_err(void *dev, const char *msg) {
}

irqreturn_t v3d_hub_irq(int irq, void *arg) {
    return IRQ_NONE;
}

static irqreturn_t v3d_irq(int irq, void *arg)
{
    struct v3d_dev *v3d = arg;
    u32 intsts;
    irqreturn_t status = IRQ_NONE;

    intsts = V3D_CORE_READ(0, 0);

    V3D_CORE_WRITE(0, 0, intsts);

    if (intsts & 1) {
        schedule_work(v3d->overflow_mem_work);
        status = IRQ_HANDLED;
    }

    if (intsts & 2) {
        struct v3d_fence *fence =
            to_v3d_fence(v3d->bin_job->irq_fence);

        trace_v3d_bcl_irq(&v3d->drm, fence->seqno);
        dma_fence_signal(&fence->base);
        status = IRQ_HANDLED;
    }

    if (intsts & 4) {
        struct v3d_fence *fence =
            to_v3d_fence(v3d->render_job->irq_fence);

        trace_v3d_rcl_irq(&v3d->drm, fence->seqno);
        dma_fence_signal(&fence->base);
        status = IRQ_HANDLED;
    }

    if (intsts & 8) {
        struct v3d_fence *fence =
            to_v3d_fence(v3d->csd_job->irq_fence);

        trace_v3d_csd_irq(&v3d->drm, fence->seqno);
        dma_fence_signal(&fence->base);
        status = IRQ_HANDLED;
    }

    if (intsts & 16)
        dev_err(v3d->drm.dev, "GMP violation\n");

    if (v3d->single_irq_line && status == IRQ_NONE)
        return v3d_hub_irq(irq, arg);

    return status;
}

