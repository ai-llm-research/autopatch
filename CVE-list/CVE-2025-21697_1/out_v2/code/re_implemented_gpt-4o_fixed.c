

typedef int irqreturn_t;
#define IRQ_NONE 0
#define IRQ_HANDLED 1

typedef unsigned int u32;

typedef struct {} irq_struct_stub;

struct v3d_fence {
    struct { } base;
    int seqno;
};

struct v3d_dev {
    struct drm_stub {
        struct dev_stub {
        } *dev;
    } drm;
    struct job_stub {
        struct v3d_fence *irq_fence;
    } *bin_job, *render_job, *csd_job;
    struct work_struct {
    } overflow_mem_work;
    int single_irq_line;
};

u32 V3D_CORE_READ(int core, int reg) {
    return 0;
}

void V3D_CORE_WRITE(int core, int reg, u32 value) {
}

void schedule_work(struct work_struct *work) {
}

struct v3d_fence *to_v3d_fence(struct v3d_fence *fence) {
    return fence;
}

void trace_v3d_bcl_irq(void *drm, int seqno) {
}

void trace_v3d_rcl_irq(void *drm, int seqno) {
}

void trace_v3d_csd_irq(void *drm, int seqno) {
}

void dma_fence_signal(void *fence) {
}

void dev_err(void *dev, const char *fmt, ...) {
}

irqreturn_t v3d_hub_irq(int irq, void *arg) {
    return IRQ_NONE;
}

// Interrupt status bits
#define V3D_INT_OUT_OF_MEM (1 << 0)
#define V3D_INT_BINNING_DONE (1 << 1)
#define V3D_INT_RENDERING_DONE (1 << 2)
#define V3D_INT_CSD_DONE (1 << 3)
#define V3D_INT_GMP_VIOLATION (1 << 4)

static irqreturn_t v3d_irq(int irq, void *arg) {
    struct v3d_dev *v3d = arg;
    u32 intsts;
    irqreturn_t status = IRQ_NONE;

    intsts = V3D_CORE_READ(0, 0);

    V3D_CORE_WRITE(0, 0, intsts);

    if (intsts & V3D_INT_OUT_OF_MEM) {
        schedule_work(&v3d->overflow_mem_work);
        status = IRQ_HANDLED;
    }
    if (intsts & V3D_INT_BINNING_DONE) {
        struct v3d_fence *fence = to_v3d_fence(v3d->bin_job->irq_fence);
        trace_v3d_bcl_irq(&v3d->drm, fence->seqno);
        dma_fence_signal(&fence->base);
        status = IRQ_HANDLED;
    }
    if (intsts & V3D_INT_RENDERING_DONE) {
        struct v3d_fence *fence = to_v3d_fence(v3d->render_job->irq_fence);
        trace_v3d_rcl_irq(&v3d->drm, fence->seqno);
        dma_fence_signal(&fence->base);
        status = IRQ_HANDLED;
    }
    if (intsts & V3D_INT_CSD_DONE) {
        struct v3d_fence *fence = to_v3d_fence(v3d->csd_job->irq_fence);
        trace_v3d_csd_irq(&v3d->drm, fence->seqno);
        dma_fence_signal(&fence->base);
        status = IRQ_HANDLED;
    }
    if (intsts & V3D_INT_GMP_VIOLATION)
        dev_err(v3d->drm.dev, "GMP Violation\n");

    if (v3d->single_irq_line && status == IRQ_NONE)
        status = v3d_hub_irq(irq, arg);

    return status;
}

