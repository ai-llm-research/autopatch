

struct v3d_dev {
    int ver;
    int single_irq_line;
    struct {
        int dev;
    } drm;
    struct job {
        struct v3d_fence *base;
    } *bin_job, *render_job, *csd_job;
    void *overflow_mem_work;
};

struct v3d_fence {
    struct base_fence {
        void *irq_fence;
    } base;
    unsigned int seqno;
};

typedef int irqreturn_t;
typedef unsigned int u32;

#define IRQ_NONE 0
#define IRQ_HANDLED 1

u32 V3D_READ(int addr) {
    return 0;
}

void V3D_WRITE(int addr, u32 val) {}

#define V3D_INTR_STATUS 0
#define V3D_INTR_CLEAR 0
#define V3D_INTR_OUTOFMEM 0x1
#define V3D_INTR_BINNINGDONE 0x2
#define V3D_INTR_RENDERINGDONE 0x4
#define V3D_INTR_CSDDONE 0x8
#define V3D_V7_INTR_GMPVIOLATION 0x10

void schedule_work(void *work) {}

struct v3d_fence *to_v3d_fence(void *fence) {
    return (struct v3d_fence *)fence;
}

void trace_v3d_bcl_irq(void *drm, unsigned int seqno) {}
void trace_v3d_rcl_irq(void *drm, unsigned int seqno) {}
void trace_v3d_csd_irq(void *drm, unsigned int seqno) {}

void dma_fence_signal(struct v3d_fence *fence) {}

void dev_err(int dev, const char *format, ...) {}

irqreturn_t v3d_hub_irq(int irq, void *arg) {
    return IRQ_NONE;
}

static irqreturn_t v3d_irq(int irq, void *arg)
{
    struct v3d_dev *v3d = arg;
    u32 intsts;
    irqreturn_t status = IRQ_NONE;

    intsts = V3D_READ(V3D_INTR_STATUS);
    V3D_WRITE(V3D_INTR_CLEAR, intsts);

    if (intsts & V3D_INTR_OUTOFMEM) {
        schedule_work(&v3d->overflow_mem_work);
        status = IRQ_HANDLED;
    }

    if (intsts & V3D_INTR_BINNINGDONE) {
        struct v3d_fence *fence = v3d->bin_job->base;

        trace_v3d_bcl_irq(&v3d->drm, fence->seqno);

        dma_fence_signal(fence);

        status = IRQ_HANDLED;
    }

    if (intsts & V3D_INTR_RENDERINGDONE) {
        struct v3d_fence *fence = v3d->render_job->base;

        trace_v3d_rcl_irq(&v3d->drm, fence->seqno);

        dma_fence_signal(fence);

        status = IRQ_HANDLED;
    }

    if (intsts & V3D_INTR_CSDDONE) {
        struct v3d_fence *fence = v3d->csd_job->base;

        trace_v3d_csd_irq(&v3d->drm, fence->seqno);

        dma_fence_signal(fence);

        status = IRQ_HANDLED;
    }

    if (v3d->ver >= 71 && (intsts & V3D_V7_INTR_GMPVIOLATION)) {
        dev_err(v3d->drm.dev, "GMP Violation\n");
        status = IRQ_HANDLED;
    }

    if (!status && !v3d->single_irq_line)
        status = v3d_hub_irq(irq, arg);

    return status;
}

