

typedef int irqreturn_t;
#define IRQ_NONE 0
#define IRQ_HANDLED 1
#define IRQ_WAKE_THREAD 2

typedef int irq_t;
typedef unsigned int u32;
typedef int bool;

struct v3d_fence {
    struct {
        int base;
    } base;
    int seqno;
};

struct v3d_dev {
    bool single_irq_line;
    int drm;
    struct {
        struct v3d_fence *irq_fence;
    } *bin_job, *render_job, *csd_job;
    void *overflow_mem_work;
};

u32 V3D_READ(int reg) {
    return 0;
}

void V3D_WRITE(int reg, u32 value) {}

void schedule_work(void *work) {}

struct v3d_fence *to_v3d_fence(void *irq_fence) {
    return (struct v3d_fence*)0;
}

void trace_v3d_bcl_irq(int *drm, int seqno) {}

void trace_v3d_rcl_irq(int *drm, int seqno) {}

void trace_v3d_csd_irq(int *drm, int seqno) {}

void dma_fence_signal(int *base) {}

void dev_err(void *dev, const char *fmt, ...) {}

irqreturn_t v3d_hub_irq(irq_t irq, void *arg) {
    return IRQ_NONE;
}

static irqreturn_t v3d_irq(int irq, void *arg)
{
    struct v3d_dev *v3d = (struct v3d_dev *)arg;
    u32 intsts;
    irqreturn_t status = IRQ_NONE;

    intsts = V3D_READ(0);

    V3D_WRITE(0, intsts);

    if (intsts & 1) {
        schedule_work(&v3d->overflow_mem_work);
        status = IRQ_WAKE_THREAD;
    }

    if (intsts & 2) {
        struct v3d_fence *fence = to_v3d_fence(v3d->bin_job->irq_fence);
        trace_v3d_bcl_irq(&v3d->drm, fence->seqno);
        dma_fence_signal(&fence->base.base);
        status = IRQ_HANDLED;
    }

    if (intsts & 4) {
        struct v3d_fence *fence = to_v3d_fence(v3d->render_job->irq_fence);
        trace_v3d_rcl_irq(&v3d->drm, fence->seqno);
        dma_fence_signal(&fence->base.base);
        status = IRQ_HANDLED;
    }

    if (intsts & 8) {
        struct v3d_fence *fence = to_v3d_fence(v3d->csd_job->irq_fence);
        trace_v3d_csd_irq(&v3d->drm, fence->seqno);
        dma_fence_signal(&fence->base.base);
        status = IRQ_HANDLED;
    }

    if (intsts & 16) {
        dev_err(&v3d->drm, "GMP Violation\n");
        status = IRQ_HANDLED;
    }

    if (!status && !v3d->single_irq_line)
        status = v3d_hub_irq(irq, arg);

    return status;
}

