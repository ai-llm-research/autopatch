

typedef unsigned long size_t;

struct kref {};
struct rtrs_rdma_dev_pd {
    struct mutex {
        // Stub for mutex
    } mutex;
};
struct rtrs_ib_dev {
    struct kref *ref;
    struct rtrs_rdma_dev_pd *pool;
    struct entry {
        // Stub for list entry
    } entry;
    void *ib_pd;
};

void mutex_lock(struct mutex *m) {
    // Stub for mutex_lock
}

void mutex_unlock(struct mutex *m) {
    // Stub for mutex_unlock
}

void list_del(struct entry *e) {
    // Stub for list_del
}

void ib_dealloc_pd(void *pd) {
    // Stub for ib_dealloc_pd
}

void kfree(void *ptr) {
    // Stub for kfree
}

size_t offsetof_helper(size_t ref) {
    return 0;
}

#define container_of(ptr, type, member) ((type *)((char *)(ptr) - offsetof_helper((size_t)&((type *)0)->member)))

static void dev_free(struct kref *ref)
{
    struct rtrs_rdma_dev_pd *pool;
    struct rtrs_ib_dev *dev;

    dev = container_of(ref, struct rtrs_ib_dev, ref);
    pool = dev->pool;

    mutex_lock(&pool->mutex);
    list_del(&dev->entry);
    mutex_unlock(&pool->mutex);

    ib_dealloc_pd(dev->ib_pd);
    kfree(dev);
}

