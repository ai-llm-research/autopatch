

typedef unsigned long size_t;

struct kref {};

struct mutex {};

struct rtrs_rdma_dev_pd {
    struct mutex mutex;
};

struct entry {};

struct rtrs_ib_dev {
    struct rtrs_rdma_dev_pd *pool;
    struct kref ref;
    int ib_pd;
    struct entry entry;
};

void mutex_lock(struct mutex *m) {}
void mutex_unlock(struct mutex *m) {}
void list_del(struct entry *e) {}
void ib_dealloc_pd(int pd) {}
void kfree(struct rtrs_ib_dev *dev) {}

#define offsetof(type, member) ((size_t) &(((type *)0)->member))

static struct rtrs_ib_dev* container_of(struct kref *ref, struct rtrs_ib_dev *type, struct kref *member) {
    return (struct rtrs_ib_dev *)((char *)ref - offsetof(struct rtrs_ib_dev, ref));
}

static void dev_free(struct kref *ref) {
    struct rtrs_rdma_dev_pd *pool;
    struct rtrs_ib_dev *dev;

    dev = container_of(ref, dev, &dev->ref);
    pool = dev->pool;

    mutex_lock(&pool->mutex);
    list_del(&dev->entry);
    mutex_unlock(&pool->mutex);

    ib_dealloc_pd(dev->ib_pd);
    kfree(dev);
}

