

struct kref {
    int refcount;
};

struct rtrs_rdma_dev_pd {
    int dummy;
    int mutex;
};

struct rtrs_ib_dev {
    struct kref ref;
    struct rtrs_rdma_dev_pd *pool;
    int entry;
    int ib_pd;
};

void mutex_lock(int *mutex) {
    // Stub for mutex_lock
}

void mutex_unlock(int *mutex) {
    // Stub for mutex_unlock
}

void list_del(int *entry) {
    // Stub for list_del
}

void ib_dealloc_pd(int pd) {
    // Stub for ib_dealloc_pd
}

void kfree(struct rtrs_ib_dev *dev) {
    // Stub for kfree
}

typedef unsigned long size_t;

#define offsetof(TYPE, MEMBER) ((size_t) &((TYPE *)0)->MEMBER)

#define container_of(ptr, type, member) \
    ((type *)((char *)(ptr) - offsetof(type, member)))

static void dev_free(struct kref *ref) {
    struct rtrs_rdma_dev_pd *pool;
    struct rtrs_ib_dev *dev;

    dev = container_of(ref, struct rtrs_ib_dev, ref);
    pool = dev->pool;

    mutex_lock(&pool->mutex);
    list_del(&dev->entry);
    mutex_unlock(&pool->mutex);

    ib_dealloc_pd(dev->ib_pd);
    kfree(dev);
}

