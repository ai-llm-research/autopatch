
struct rcar_pcie_endpoint {
    struct rcar_pcie *pcie;
    unsigned int num_ob_windows;
    unsigned long ob_mapped_addr[10];
    struct {
        unsigned long page_size;
        unsigned long phys_offset;
        void *cpu_addr;
        unsigned long len;
    } ob_window[10];
};

struct rcar_pcie {
    void *dev;
};

struct platform_device {
    const char *name;
};

struct resource {
    unsigned long start;
    unsigned long end;
};

#define RCAR_PCIE_MAX_RESOURCES 10
#define MAX_OB_WINDOWS 10
#define IORESOURCE_MEM 0
#define EINVAL 22
#define EIO 5

unsigned long resource_size(const struct resource *res) {
    return res->end - res->start;
}

struct resource *platform_get_resource(struct platform_device *pdev, unsigned int type, int num) {
    return 0; // stub
}

void dev_err(void *dev, const char *fmt, ...) {
    // stub
}

int devm_request_mem_region(void *dev, unsigned long start, unsigned long n, const char *name) {
    return 1; // stub for success
}

static int rcar_pcie_parse_outbound_ranges(struct rcar_pcie_endpoint *ep, struct platform_device *pdev) {
    struct rcar_pcie *pci = ep->pcie;
    char ob_res_name[32];
    struct resource *ob_res;
    ep->num_ob_windows = 0;
    for (int i = 0; i < RCAR_PCIE_MAX_RESOURCES && ep->num_ob_windows < MAX_OB_WINDOWS; ++i) {
        snprintf(ob_res_name, sizeof(ob_res_name), "%s-ob%d", pdev->name, i);
        ob_res = platform_get_resource(pdev, IORESOURCE_MEM, i);
        if (!ob_res) {
            dev_err(pci->dev, "Outbound window %s not available\n", ob_res_name);
            return -EINVAL;
        }
        if (!devm_request_mem_region(pci->dev, ob_res->start, resource_size(ob_res), ob_res_name)) {
            dev_err(pci->dev, "Failed to request outbound mem region for %s\n", ob_res_name);
            return -EIO;
        }
        ep->ob_mapped_addr[i] = ob_res->start;
        ep->ob_window[i].page_size = resource_size(ob_res);
        ep->ob_window[i].phys_offset = 0;
        ep->ob_window[i].cpu_addr = (void *)ob_res->start;
        ep->ob_window[i].len = resource_size(ob_res);
        ep->num_ob_windows++;
    }
    return 0;
}
