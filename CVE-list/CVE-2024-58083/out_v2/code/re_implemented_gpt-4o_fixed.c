

typedef struct kvm {
    int online_vcpus;
    void *vcpu_array;
} kvm;

typedef struct kvm_vcpu {
    // Minimal representation of kvm_vcpu
} kvm_vcpu;

int atomic_read(int *ptr) {
    // Stub of atomic_read function
    return *ptr;
}

int array_index_nospec(int i, int max) {
    // Stub of array_index_nospec function to ensure index is within bounds
    if (i < 0) return 0;
    if (i >= max) return max - 1;
    return i;
}

void smp_rmb() {
    // Stub of smp_rmb function
}

struct kvm_vcpu* xa_load(void *array, int i) {
    // Stub of xa_load function
    return (struct kvm_vcpu*)array;
}

static inline struct kvm_vcpu *kvm_get_vcpu_impl(struct kvm *kvm, int i) {
    int online_vcpus = atomic_read(&kvm->online_vcpus);
    i = array_index_nospec(i, online_vcpus);
    smp_rmb();
    return xa_load(&kvm->vcpu_array, i);
}

struct kvm_vcpu *kvm_get_vcpu(struct kvm *kvm, int i) {
    return kvm_get_vcpu_impl(kvm, i);
}

