

struct kvm {
    int online_vcpus;
    void *vcpu_array;
};

struct kvm_vcpu {};

int atomic_read(int *ptr) {
    return *ptr;
}

int array_index_nospec(int i, int online) {
    if (i < 0) return 0;
    if (i >= online) return online - 1;
    return i;
}

void smp_rmb() {
    // Memory barrier implementation if needed
}

void *xa_load(void *array, int i) {
    // Simulate loading from an array
    return (void *)0;
}

static inline struct kvm_vcpu *kvm_get_vcpu(struct kvm *kvm, int i) {
    int online = atomic_read(&kvm->online_vcpus);
    i = array_index_nospec(i, online);
    smp_rmb();
    return (struct kvm_vcpu *)xa_load(&kvm->vcpu_array, i);
}

