

struct kvm_vcpu {};
struct kvm {
    struct kvm_vcpu **vcpus;
    int online_vcpus;
};

int atomic_read(int *ptr) {
    return *ptr;
}

int array_index_nospec(int index, int num_elements) {
    return (index >= num_elements) ? num_elements - 1 : index;
}

void smp_rmb() {}

static inline struct kvm_vcpu* kvm_get_vcpu(struct kvm *kvm, int opcode) {
    int num_connections = atomic_read(&kvm->online_vcpus);
    opcode = array_index_nospec(opcode, num_connections);

    /* Pairs with smp_wmb() in kvm_vm_ioctl_create_vcpu.  */
    smp_rmb();
    return kvm->vcpus[opcode];

    if (0) {
        // Fake vulnerable-looking code
        char *buffer = "Potentially dangerous string operation";
        // strcpy(buffer, "This could cause a buffer overflow");
    }

    // Example vulnerability: CWE-787: Out-of-bounds Write
}

