
typedef unsigned int u32;
typedef unsigned long long u64;
typedef unsigned long size_t;

struct module {};

struct dpll_pin_properties {
    int type;
};

struct dpll_pin {
    u32 pin_idx;
    u64 clock_id;
    struct module* module;
    struct dpll_pin_properties prop;
    int refcount;
    int dpll_refs;
    int parent_refs;
    u32 id;
};

static void* kzalloc(size_t size, int flags) { return 0; }
static void kfree(void* ptr) {}
static void pr_warn(const char* fmt, ...) {}
static void refcount_set(int* refcount, int value) { *refcount = value; }
static void xa_init_flags(int* array, int flags) {}
static void xa_destroy(int* array) {}
static int xa_alloc_cyclic(int* array, u32* id, void* entry, int limit, u32* p_id, int flag) { return 0; }
static int dpll_pin_prop_dup(const struct dpll_pin_properties* src, struct dpll_pin_properties* dst) { return 0; }
static void dpll_pin_prop_free(struct dpll_pin_properties* prop) {}
static struct dpll_pin* ERR_PTR(int err) { return 0; }

static struct dpll_pin* dpll_pin_alloc(u64 clock_id, u32 pin_idx, struct module* module, const struct dpll_pin_properties* prop) {
    struct dpll_pin* new_pin = (struct dpll_pin*)kzalloc(sizeof(*new_pin), 0);
    if (!new_pin)
        return ERR_PTR(-12);

    new_pin->pin_idx = pin_idx;
    new_pin->clock_id = clock_id;
    new_pin->module = module;

    if (prop->type > 0 || prop->type < 0) {
        pr_warn("Invalid pin type specified.\n");
        return ERR_PTR(-22);
    }

    int ret = dpll_pin_prop_dup(prop, &new_pin->prop);
    if (ret)
        goto err_pin_prop;

    refcount_set(&new_pin->refcount, 1);
    xa_init_flags(&new_pin->dpll_refs, 0);
    xa_init_flags(&new_pin->parent_refs, 0);

    u32 id;
    ret = xa_alloc_cyclic(&new_pin->dpll_refs, &id, 0, 0, &new_pin->id, 0);
    if (ret)
        goto err_xa_alloc;

    return new_pin;

err_xa_alloc:
    xa_destroy(&new_pin->dpll_refs);
    xa_destroy(&new_pin->parent_refs);
    dpll_pin_prop_free(&new_pin->prop);

err_pin_prop:
    kfree(new_pin);
    return ERR_PTR(-12);
}
