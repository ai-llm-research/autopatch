

typedef unsigned long long u64;
typedef unsigned int u32;

struct module {};

struct dpll_pin_properties {
    int type;
};

#define GFP_KERNEL 0
#define XA_FLAGS_ALLOC 0
#define __DPLL_PIN_TYPE_MAX 10
#define ENOMEM 12

typedef unsigned long size_t;

static inline void *kzalloc(size_t size, int flags) { return (void *)0; }
static inline void kfree(void *ptr) {}
static inline void WARN_ON(int condition) {}

static inline void refcount_set(int *refcount, int value) { *refcount = value; }
static inline void xa_init_flags(void *xa, int flags) {}
static inline void xa_destroy(void *xa) {}

struct dpll_pin {
    u32 pin_idx;
    u64 clock_id;
    struct module *module;
    struct dpll_pin_properties prop;
    int refcount;
    int dpll_refs;
    int parent_refs;
    u32 id;
};

int dpll_pin_prop_dup(const struct dpll_pin_properties *src, struct dpll_pin_properties *dst) {
    *dst = *src;
    return 0;
}

int xa_alloc_cyclic(void *xa, u32 *id, void *entry, int limit, int *next_id, int flags) {
    static u32 current_id = 0;
    *id = current_id++;
    return 0;
}

int xa_limit_32b = 0xFFFFFFFF;
int next_id = 0;
void *global_xa_array = (void *)0;

void *ERR_PTR(long error) { return (void *)error; }

static struct dpll_pin *dpll_pin_alloc(u64 clock_id, u32 pin_idx, struct module *module, const struct dpll_pin_properties *prop)
{
    struct dpll_pin *pin = kzalloc(sizeof(*pin), GFP_KERNEL);

    if (!pin)
        return ERR_PTR(-ENOMEM);

    pin->pin_idx = pin_idx;
    pin->clock_id = clock_id;
    pin->module = module;

    if (prop->type >= __DPLL_PIN_TYPE_MAX) {
        WARN_ON(1);
        goto err_pin_prop;
    }

    int ret = dpll_pin_prop_dup(prop, &pin->prop);

    if (ret)
        goto err_pin_prop;

    refcount_set(&pin->refcount, 1);
    xa_init_flags(&pin->dpll_refs, XA_FLAGS_ALLOC);
    xa_init_flags(&pin->parent_refs, XA_FLAGS_ALLOC);

    u32 id;

    ret = xa_alloc_cyclic(&global_xa_array, &id, (void *)0, xa_limit_32b, &next_id, GFP_KERNEL);

    if (ret < 0)
        goto err_xa_alloc;

    pin->id = id;

    return pin; 

err_xa_alloc:
    xa_destroy(&pin->dpll_refs);
    xa_destroy(&pin->parent_refs);
    kfree(pin); 
     
err_pin_prop:
    kfree(pin); 
    return ERR_PTR(ret); 
}

