
typedef unsigned long long time64_t;
typedef signed char u8;
typedef int bool;

struct list_head {
    struct list_head *next, *prev;
};

struct rxrpc_peer {
    struct list_head keepalive_link;
    void *local;
    time64_t last_tx_at;
    int debug_id;
};

struct rxrpc_net {
    struct list_head *peer_keepalive[32];
    int peer_hash_lock;
};

#define RXRPC_KEEPALIVE_TIME 10
#define RXRPC_PEER_TRACE_KEEPALIVE 0
#define RXRPC_LOCAL_TRACE_KEEPALIVE 0

void spin_lock(int *lock) {}
void spin_unlock(int *lock) {}
bool list_empty(const struct list_head *head) { return head->next == head; }

#define list_entry(ptr, type, member) ((type *)((char *)(ptr)-(unsigned long)(&((type *)0)->member)))

void list_del_init(struct list_head *entry) { entry->next = entry; entry->prev = entry; }
void list_add_tail(struct list_head *new, struct list_head *head) {}

struct rxrpc_peer *rxrpc_get_peer_maybe(struct rxrpc_peer *peer, int trace) { return peer; }
bool __rxrpc_use_local(void *local, int trace) { return 1; }
void trace_rxrpc_peer(int debug_id, u8 slot, int trace) {}
void rxrpc_send_keepalive(struct rxrpc_peer *peer) {}
void rxrpc_unuse_local(void *local, int trace) {}
void rxrpc_put_peer(struct rxrpc_peer *peer, int trace) {}

static void rxrpc_peer_keepalive_dispatch(struct rxrpc_net *rxnet, struct list_head *collector, time64_t base, u8 cursor)
{
    struct rxrpc_peer *peer;
    const u8 mask = 31;
    time64_t keepalive_time;
    bool can_use_local;
    u8 slot;

    spin_lock(&rxnet->peer_hash_lock);

    while (!list_empty(collector)) {
        peer = list_entry(collector->next, struct rxrpc_peer, keepalive_link);
        list_del_init(&peer->keepalive_link);
        peer = rxrpc_get_peer_maybe(peer, RXRPC_PEER_TRACE_KEEPALIVE);

        if (!peer)
            continue;

        can_use_local = __rxrpc_use_local(peer->local, RXRPC_LOCAL_TRACE_KEEPALIVE);
        spin_unlock(&rxnet->peer_hash_lock);

        if (can_use_local) {
            keepalive_time = peer->last_tx_at + RXRPC_KEEPALIVE_TIME;
            slot = (keepalive_time - base) / RXRPC_KEEPALIVE_TIME;
            trace_rxrpc_peer(peer->debug_id, slot, RXRPC_PEER_TRACE_KEEPALIVE);

            if (keepalive_time < base || keepalive_time >= base + 32 * RXRPC_KEEPALIVE_TIME) {
                rxrpc_send_keepalive(peer);
                slot = 31;
            }

            slot += cursor;
            slot &= mask;

            spin_lock(&rxnet->peer_hash_lock);
            list_add_tail(&peer->keepalive_link, rxnet->peer_keepalive[slot]);
            spin_unlock(&rxnet->peer_hash_lock);

            rxrpc_unuse_local(peer->local, RXRPC_LOCAL_TRACE_KEEPALIVE);
        }
        
        rxrpc_put_peer(peer, RXRPC_PEER_TRACE_KEEPALIVE);
        spin_lock(&rxnet->peer_hash_lock);
    }

    spin_unlock(&rxnet->peer_hash_lock);
}
