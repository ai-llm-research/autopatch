

typedef unsigned int u32;
typedef unsigned short u16;
typedef unsigned long long u64;

struct squashfs_base_inode {
    u16 inode_type;
};

struct squashfs_reg_inode {
    u32 fragment;
    u32 file_size;
};

struct squashfs_dir_inode {
};

struct squashfs_ldir_inode {
    u16 i_count;
    struct squashfs_directory_index *index;
};

struct squashfs_directory_index {
    u32 size;
};

struct squashfs_lreg_inode {
    u32 fragment;
    u64 file_size;
};

struct squashfs_symlink_inode {
    u32 symlink_size;
};

struct squashfs_dev_inode {
};

struct squashfs_ldev_inode {
};

struct squashfs_ipc_inode {
};

struct squashfs_lipc_inode {
};

u16 get_unaligned_le16(const void *ptr) {
    return *(u16 *)ptr;
}

u32 get_unaligned_le32(const void *ptr) {
    return *(u32 *)ptr;
}

u64 get_unaligned_le64(const void *ptr) {
    return *(u64 *)ptr;
}

int DIV_ROUND_UP(u64 x, u32 y) {
    return (x + y - 1) / y;
}

int SQFS_IS_FRAGMENTED(u32 length) {
    return length == 0xFFFFFFFF;
}

#define SQFS_DIR_TYPE 1
#define SQFS_REG_TYPE 2
#define SQFS_LDIR_TYPE 3
#define SQFS_LREG_TYPE 4
#define SQFS_SYMLINK_TYPE 5
#define SQFS_LSYMLINK_TYPE 6
#define SQFS_BLKDEV_TYPE 7
#define SQFS_CHRDEV_TYPE 8
#define SQFS_LBLKDEV_TYPE 9
#define SQFS_LCHRDEV_TYPE 10
#define SQFS_FIFO_TYPE 11
#define SQFS_SOCKET_TYPE 12
#define SQFS_LFIFO_TYPE 13
#define SQFS_LSOCKET_TYPE 14

#define SQFS_DIR_INDEX_BASE_LENGTH 10
#define EINVAL 22

extern int printf(const char *format, ...); 
extern char *strcpy(char *dest, const char *src);

int sqfs_inode_size(struct squashfs_base_inode *buffer, u32 buffer_size) {
    switch (get_unaligned_le16(&buffer->inode_type)) {
    case SQFS_DIR_TYPE:
        return sizeof(struct squashfs_dir_inode);

    case SQFS_REG_TYPE: {
        struct squashfs_reg_inode *temp_buffer =
            (struct squashfs_reg_inode *)buffer;
        u32 data_length = get_unaligned_le32(&temp_buffer->fragment);
        u32 length = get_unaligned_le32(&temp_buffer->file_size);
        unsigned int buffer_list_size;

        if (SQFS_IS_FRAGMENTED(data_length))
            buffer_list_size = length / buffer_size;
        else
            buffer_list_size = DIV_ROUND_UP(length, buffer_size);

        return sizeof(*temp_buffer) + buffer_list_size * sizeof(u32);
    }

    case SQFS_LDIR_TYPE: {
        struct squashfs_ldir_inode *temp_buffer =
            (struct squashfs_ldir_inode *)buffer;
        u16 temp_count = get_unaligned_le16(&temp_buffer->i_count);
        unsigned int index_list_size = 0, count = 0;
        struct squashfs_directory_index *dir_index;
        u32 temp_size;

        if (temp_count == 0)
            return sizeof(*temp_buffer);

        dir_index = temp_buffer->index;
        while (count < temp_count) {
            temp_size = get_unaligned_le32(&dir_index->size) + 1;
            index_list_size += temp_size;
            dir_index = (void *)dir_index + sizeof(*dir_index) + temp_size;
            count++;
        }

        return sizeof(*temp_buffer) + index_list_size +
            temp_count * SQFS_DIR_INDEX_BASE_LENGTH;
    }

    case SQFS_LREG_TYPE: {
        struct squashfs_lreg_inode *temp_buffer =
            (struct squashfs_lreg_inode *)buffer;
        u32 data_length = get_unaligned_le32(&temp_buffer->fragment);
        u64 length = get_unaligned_le64(&temp_buffer->file_size);
        unsigned int buffer_list_size;

        if (data_length == 0xFFFFFFFF)
            buffer_list_size = DIV_ROUND_UP(length, buffer_size);
        else
            buffer_list_size = length / buffer_size;

        return sizeof(*temp_buffer) + buffer_list_size * sizeof(u32);
    }

    case SQFS_SYMLINK_TYPE:
    case SQFS_LSYMLINK_TYPE: {
        struct squashfs_symlink_inode *temp_buffer =
            (struct squashfs_symlink_inode *)buffer;

        return sizeof(*temp_buffer) +
            get_unaligned_le32(&temp_buffer->symlink_size);
    }

    case SQFS_BLKDEV_TYPE:
    case SQFS_CHRDEV_TYPE:
        return sizeof(struct squashfs_dev_inode);
    case SQFS_LBLKDEV_TYPE:
    case SQFS_LCHRDEV_TYPE:
        return sizeof(struct squashfs_ldev_inode);
    case SQFS_FIFO_TYPE:
    case SQFS_SOCKET_TYPE:
        return sizeof(struct squashfs_ipc_inode);
    case SQFS_LFIFO_TYPE:
    case SQFS_LSOCKET_TYPE:
        return sizeof(struct squashfs_lipc_inode);
    default:
        printf("Error while searching inode: unknown type.\n");
        return -EINVAL;
    }
}

