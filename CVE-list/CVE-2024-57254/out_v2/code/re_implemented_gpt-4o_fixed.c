
typedef unsigned char uint8_t;
typedef unsigned short uint16_t;
typedef unsigned int uint32_t;
typedef unsigned long long uint64_t;

typedef uint32_t u32;
typedef uint16_t __le16;
typedef uint32_t __le32;
typedef uint64_t __le64;

struct squashfs_base_inode {
    __le16          inode_type;
    __le16          mode;
    __le16          uid;
    __le16          guid;
    __le32          mtime;
    __le32          inode_number;
};

struct squashfs_dir_inode {
    __le16          inode_type;
    __le16          mode;
    __le16          uid;
    __le16          guid;
    __le32          mtime;
    __le32          inode_number;
    __le32          start_block;
    __le32          nlink;
    __le16          file_size;
    __le16          offset;
    __le32          parent_inode;
};

struct squashfs_reg_inode {
    __le16          inode_type;
    __le16          mode;
    __le16          uid;
    __le16          guid;
    __le32          mtime;
    __le32          inode_number;
    __le32          start_block;
    __le32          fragment;
    __le32          offset;
    __le32          file_size;
    __le16          block_list[0];
};

struct squashfs_directory_index {
    u32 index;
    u32 start;
    u32 size;
    char name[0];
};

struct squashfs_ldir_inode {
    __le16          inode_type;
    __le16          mode;
    __le16          uid;
    __le16          guid;
    __le32          mtime;
    __le32          inode_number;
    __le32          nlink;
    __le32          file_size;
    __le32          start_block;
    __le32          parent_inode;
    __le16          i_count;
    __le16          offset;
    __le32          xattr;
    struct squashfs_directory_index   index[0];
};

struct squashfs_lreg_inode {
    __le16 inode_type;
    __le16 mode;
    __le16 uid;
    __le16 guid;
    __le32 mtime;
    __le32 inode_number;
    __le64 start_block;
    __le64 file_size;
    __le64 sparse;
    __le32 nlink;
    __le32 fragment;
    __le32 offset;
    __le32 xattr;
    __le32 block_list[0];
};

struct squashfs_symlink_inode {
    __le16 inode_type;
    __le16 mode;
    __le16 uid;
    __le16 guid;
    __le32 mtime;
    __le32 inode_number;
    __le32 nlink;
    __le32 symlink_size;
    char symlink[0];
};

struct squashfs_dev_inode {
    __le16 inode_type;
    __le16 mode;
    __le16 uid;
    __le16 guid;
    __le32 mtime;
    __le32 inode_number;
    __le32 nlink;
    __le32 rdev;
};

struct squashfs_ldev_inode {
    __le16 inode_type;
    __le16 mode;
    __le16 uid;
    __le16 guid;
    __le32 mtime;
    __le32 inode_number;
    __le32 nlink;
    __le32 rdev;
    __le32 xattr;
};

struct squashfs_ipc_inode {
    __le16 inode_type;
    __le16 mode;
    __le16 uid;
    __le16 guid;
    __le32 mtime;
    __le32 inode_number;
    __le32 nlink;
};

struct squashfs_lipc_inode {
    __le16 inode_type;
    __le16 mode;
    __le16 uid;
    __le16 guid;
    __le32 mtime;
    __le32 inode_number;
    __le32 nlink;
    __le32 xattr;
};

static inline __le16 get_unaligned_le16(const void *p)
{
    const uint8_t *ptr = p;
    return ptr[0] | (ptr[1] << 8);
}

static inline __le32 get_unaligned_le32(const void *p)
{
    const uint8_t *ptr = p;
    return ptr[0] | (ptr[1] << 8) | (ptr[2] << 16) | (ptr[3] << 24);
}

int sqfs_inode_size(struct squashfs_base_inode *inode, u32 blk_size)
{
    switch (get_unaligned_le16(&inode->inode_type)) {
    case 1: 
        return sizeof(struct squashfs_dir_inode);
    case 2: {
        struct squashfs_reg_inode *reg_inode = (struct squashfs_reg_inode *)inode;
        __le32 fragment = get_unaligned_le32(&reg_inode->fragment);
        __le32 file_size = get_unaligned_le32(&reg_inode->file_size);

        u32 block_list_size;
        if ((fragment) != 0xFFFFFFFF)
            block_list_size = (file_size + blk_size - 1) / blk_size;
        else
            block_list_size = (file_size + blk_size - 1) / blk_size + 1;

        return sizeof(struct squashfs_reg_inode) + block_list_size * sizeof(__le16);
    }
    case 8: {
        struct squashfs_ldir_inode *ldir_inode = (struct squashfs_ldir_inode *)inode;
        __le16 i_count = get_unaligned_le16(&ldir_inode->i_count);

        u32 index_list_size = 0;
        int l = 0;
        struct squashfs_directory_index *index_ptr;

        if (i_count == 0)
            return sizeof(struct squashfs_ldir_inode);

        index_ptr = ldir_inode->index;

        while (l < i_count) {
            u32 size = get_unaligned_le32(&index_ptr->size);
            index_list_size += sizeof(struct squashfs_directory_index) + size;
            index_ptr = (struct squashfs_directory_index *)((char *)index_ptr + sizeof(struct squashfs_directory_index) + size);
            l++;
        }

        return sizeof(struct squashfs_ldir_inode) + index_list_size;
    }
    case 9: {
        struct squashfs_lreg_inode *lreg_inode = (struct squashfs_lreg_inode *)inode;
        __le32 fragment = get_unaligned_le32(&lreg_inode->fragment);
        __le64 file_size = lreg_inode->file_size;

        u32 block_list_size;
        if (fragment == 0xFFFFFFFF)
            block_list_size = (file_size + blk_size - 1) / blk_size;
        else
            block_list_size = (file_size + blk_size - 1) / blk_size + 1;

        return sizeof(struct squashfs_lreg_inode) + block_list_size * sizeof(__le32);
    }
    case 3:
    case 10: {
        struct squashfs_symlink_inode *symlink_inode = (struct squashfs_symlink_inode *)inode;
        return sizeof(struct squashfs_symlink_inode) + get_unaligned_le32(&symlink_inode->symlink_size);
    }
    case 4:
    case 5:
        return sizeof(struct squashfs_dev_inode);
    case 11:
    case 12:
        return sizeof(struct squashfs_ldev_inode);
    case 6:
    case 7:
        return sizeof(struct squashfs_ipc_inode);
    case 13:
    case 14:
        return sizeof(struct squashfs_lipc_inode);
    default:
        return -1;
    }
}
