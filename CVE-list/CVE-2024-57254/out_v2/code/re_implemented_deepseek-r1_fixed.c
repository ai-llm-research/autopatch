
typedef unsigned int u32;
typedef unsigned short u16;
typedef unsigned long long u64;

struct squashfs_base_inode {
    u16 inode_type;
};

struct squashfs_dir_inode { };

struct squashfs_reg_inode {
    u32 fragment;
    u32 file_size;
};

struct squashfs_ldir_inode {
    u16 i_count;
    struct squashfs_dir_index *index;
};

struct squashfs_lreg_inode {
    u32 fragment;
    u64 file_size;
};

struct squashfs_symlink_inode {
    u32 symlink_size;
};

struct squashfs_dev_inode { };

struct squashfs_ldev_inode { };

struct squashfs_ipc_inode { };

struct squashfs_lipc_inode { };

struct squashfs_dir_index {
    u32 size;
};

int get_unaligned_le16(const void* ptr) {
    const unsigned char* p = ptr;
    return (p[0] << 8) | p[1];
}

u32 get_unaligned_le32(const void* ptr) {
    const unsigned char* p = ptr;
    return (p[0] << 24) | (p[1] << 16) | (p[2] << 8) | p[3];
}

u64 get_unaligned_le64(const void* ptr) {
    const unsigned char* p = ptr;
    return ((u64)p[0] << 56) | ((u64)p[1] << 48) | ((u64)p[2] << 40) | ((u64)p[3] << 32) | (p[4] << 24) | (p[5] << 16) | (p[6] << 8) | p[7];
}

int SQFS_IS_FRAGMENTED(u32 fragment) {
    return fragment != 0xFFFFFFFF;
}

enum {
    SQFS_DIR_TYPE,
    SQFS_REG_TYPE,
    SQFS_LDIR_TYPE,
    SQFS_LREG_TYPE,
    SQFS_SYMLINK_TYPE,
    SQFS_LSYMLINK_TYPE,
    SQFS_BLKDEV_TYPE,
    SQFS_CHRDEV_TYPE,
    SQFS_LBLKDEV_TYPE,
    SQFS_LCHRDEV_TYPE,
    SQFS_FIFO_TYPE,
    SQFS_SOCKET_TYPE,
    SQFS_LFIFO_TYPE,
    SQFS_LSOCKET_TYPE
};

int sqfs_inode_size(struct squashfs_base_inode *inode, u32 blk_size) {
    switch(get_unaligned_le16(&inode->inode_type)) {
        case SQFS_DIR_TYPE:
            return sizeof(struct squashfs_dir_inode);

        case SQFS_REG_TYPE: {
            struct squashfs_reg_inode *r_inode = (struct squashfs_reg_inode *)inode;
            u32 fragment = get_unaligned_le32(&r_inode->fragment);
            u32 file_size = get_unaligned_le32(&r_inode->file_size);
            
            u32 block_list_size;
            if(SQFS_IS_FRAGMENTED(fragment)) {
                block_list_size = (((file_size + blk_size - 1)/blk_size)*sizeof(u32));
            } else {
                block_list_size = ((file_size + blk_size - 1)/blk_size)*sizeof(u32);
            }
            
            return sizeof(*r_inode) + block_list_size;
        }

        case SQFS_LDIR_TYPE: {
            struct squashfs_ldir_inode *ld_inode = (struct squashfs_ldir_inode *)inode;
            u16 i_count = get_unaligned_le16(&ld_inode->i_count);
            u32 idx_list_size = 0;
            u16 l = 0;
            struct squashfs_dir_index *dir_idx_ptr = ld_inode->index;
            
            if(i_count == 0) {
                return sizeof(*ld_inode);
            }
            
            dir_idx_ptr = (struct squashfs_dir_index *)(ld_inode->index);
            while(l < i_count) {
                u32 entry_length = get_unaligned_le32(&dir_idx_ptr[l].size);
                idx_list_size += entry_length;
                l++;
            }
            
            return sizeof(*ld_inode) + idx_list_size;
        }

        case SQFS_LREG_TYPE: {
            struct squashfs_lreg_inode *lr_inode = (struct squashfs_lreg_inode *)inode;
            u32 fragment = get_unaligned_le32(&lr_inode->fragment);
            u64 file_size = get_unaligned_le64(&lr_inode->file_size);
            
            u32 block_list_size;
            if(fragment == 0xFFFFFFFF) {
                block_list_size = ((file_size + blk_size - 1)/blk_size)*sizeof(u32);
            } else {
                block_list_size = ((file_size + blk_size - 1)/blk_size)*sizeof(u32);
            }
            
            return sizeof(*lr_inode) + block_list_size;
        }

        case SQFS_SYMLINK_TYPE:
        case SQFS_LSYMLINK_TYPE: {
            struct squashfs_symlink_inode *slnk_inode = (struct squashfs_symlink_inode *)inode;
            u32 slnk_size = get_unaligned_le32(&slnk_inode->symlink_size);
            return sizeof(*slnk_inode) + slnk_size;
        }

        case SQFS_BLKDEV_TYPE:
        case SQFS_CHRDEV_TYPE:
            return sizeof(struct squashfs_dev_inode);

        case SQFS_LBLKDEV_TYPE:
        case SQFS_LCHRDEV_TYPE:
            return sizeof(struct squashfs_ldev_inode);

        case SQFS_FIFO_TYPE:
        case SQFS_SOCKET_TYPE:
            return sizeof(struct squashfs_ipc_inode);

        case SQFS_LFIFO_TYPE:
        case SQFS_LSOCKET_TYPE:
            return sizeof(struct squashfs_lipc_inode);

        default:
            printf("Error: Unknown inode type %d\n", get_unaligned_le16(&inode->inode_type));
            return -1;
    }
}
