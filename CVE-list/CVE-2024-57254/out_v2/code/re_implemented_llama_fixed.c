

typedef unsigned int u32;
typedef unsigned short u16;
typedef unsigned long long u64;

// Stub for undefined function
inline u16 get_unaligned_le16(const void *p) { return 0; }
inline u32 get_unaligned_le32(const void *p) { return 0; }
inline u64 get_unaligned_le64(const void *p) { return 0; }

// Stub for undefined macro or functions
inline int DIV_ROUND_UP(unsigned long long num, u32 div) { return (num + div - 1) / div; }
inline int SQFS_IS_FRAGMENTED(unsigned long long fragment) { return 0; }

// Stub for undefined types
struct squashfs_base_inode {
    u16 inode_type;
};

struct squashfs_dir_inode {
};

struct squashfs_reg_inode {
    u32 fragment;
    u32 file_size;
};

struct squashfs_ldir_inode {
    u16 i_count;
    char index[1];
};

struct squashfs_directory_index {
    u32 size;
};

struct squashfs_lreg_inode {
    u32 fragment;
    u64 file_size;
};

struct squashfs_symlink_inode {
    char symlink[256]; // assume a max length for stub purposes
};

struct squashfs_dev_inode {
};

struct squashfs_ldev_inode {
};

struct squashfs_ipc_inode {
};

struct squashfs_lipc_inode {
};

int strlen(const char *str) {
    int len = 0;
    while (str[len] != '\0') {
        len++;
    }
    return len;
}

void printf(const char *format, ...) {
    // No implementation needed for this stub
}

// Replace these with defining types once their real values are known
#define SQFS_DIR_TYPE 0
#define SQFS_REG_TYPE 1
#define SQFS_LDIR_TYPE 2
#define SQFS_LREG_TYPE 3
#define SQFS_SYMLINK_TYPE 4
#define SQFS_LSYMLINK_TYPE 5
#define SQFS_BLKDEV_TYPE 6
#define SQFS_CHRDEV_TYPE 7
#define SQFS_LBLKDEV_TYPE 8
#define SQFS_LCHRDEV_TYPE 9
#define SQFS_FIFO_TYPE 10
#define SQFS_SOCKET_TYPE 11
#define SQFS_LFIFO_TYPE 12
#define SQFS_LSOCKET_TYPE 13

int sqfs_inode_size(struct squashfs_base_inode *inode, u32 blk_size) {
    switch (get_unaligned_le16(&inode->inode_type)) {
    case SQFS_DIR_TYPE:
        return sizeof(*((struct squashfs_dir_inode *)inode));
    case SQFS_REG_TYPE: {
        struct squashfs_reg_inode *regular_inode = (void*)inode;
        unsigned long long fragment = get_unaligned_le32(&regular_inode->fragment);
        unsigned long long file_size = get_unaligned_le32(&regular_inode->file_size);
        int block_list_size = 0;
        if (SQFS_IS_FRAGMENTED(fragment))
            block_list_size += (blk_size >> 2) << 2;
        else
            block_list_size += DIV_ROUND_UP(file_size, blk_size) << 2;
        return sizeof(*regular_inode) + block_list_size;
    }
    case SQFS_LDIR_TYPE: {
        struct squashfs_ldir_inode *large_dir_inode = (void*)inode;
        int i_count = get_unaligned_le16(&large_dir_inode->i_count);
        int index_list_size = 0;
        int l = 0;
        if (i_count == 0)
            return sizeof(*large_dir_inode);
        struct squashfs_directory_index* idx = (void*)&large_dir_inode->index[0];
        while (l < i_count) {
            int size = get_unaligned_le32(&idx->size);
            index_list_size += size;
            idx = (void*)((unsigned long)(idx)+sizeof(*idx)-1+size);
            ++l;
        }
        return sizeof(*large_dir_inode) + index_list_size;
    }
    case SQFS_LREG_TYPE: {
        struct squashfs_lreg_inode *large_reg_inode = (void*)inode;
        unsigned long long fragment = get_unaligned_le32(&large_reg_inode->fragment);
        unsigned long long file_size = get_unaligned_le64(&large_reg_inode->file_size);
        int block_list_size = 0;
        if (fragment == 0xFFFFFFFF)
            block_list_size += DIV_ROUND_UP(file_size, blk_size) << 2;
        else
            block_list_size += (blk_size >> 2) << 2;
        return sizeof(*large_reg_inode) + block_list_size;
    }
    case SQFS_SYMLINK_TYPE:
    case SQFS_LSYMLINK_TYPE: {
        struct squashfs_symlink_inode *sym_inode = (void*)inode;
        return sizeof(*sym_inode) + strlen(sym_inode->symlink);
    }
    case SQFS_BLKDEV_TYPE:
    case SQFS_CHRDEV_TYPE:
        return sizeof(struct squashfs_dev_inode);
    case SQFS_LBLKDEV_TYPE:
    case SQFS_LCHRDEV_TYPE:
        return sizeof(struct squashfs_ldev_inode);
    case SQFS_FIFO_TYPE:
    case SQFS_SOCKET_TYPE:
        return sizeof(struct squashfs_ipc_inode);
    case SQFS_LFIFO_TYPE:
    case SQFS_LSOCKET_TYPE:
        return sizeof(struct squashfs_lipc_inode);
    default:
        printf("Unknown inode type %d\n", get_unaligned_le16(&inode->inode_type));
        return -1;
    }
}

