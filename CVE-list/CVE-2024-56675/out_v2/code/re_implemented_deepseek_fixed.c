

typedef unsigned long size_t;

struct bpf_prog_array {};

struct bpf_prog {};

struct mutex {};

void mutex_lock(struct mutex *m) {}

void mutex_unlock(struct mutex *m) {}

struct bpf_prog_array *bpf_event_rcu_dereference(struct bpf_prog_array *prog_array) {
    return (struct bpf_prog_array *)0;
}

int bpf_prog_array_copy(struct bpf_prog_array *old_array, struct bpf_prog *prog, void *unused, int unused_2, struct bpf_prog_array **new_array) {
    return 0;
}

void bpf_prog_array_delete_safe(struct bpf_prog_array *old_array, struct bpf_prog *prog) {}

void rcu_assign_pointer(struct bpf_prog_array **event_prog_array, struct bpf_prog_array *new_array) {
    *event_prog_array = new_array;
}

void bpf_prog_array_free_sleepable(struct bpf_prog_array *old_array) {}

void bpf_prog_put(struct bpf_prog *prog) {}

struct perf_event {
    struct bpf_prog_array *prog_array;
    struct bpf_prog *prog;
    struct mutex child_mutex;
};

void perf_event_detach_bpf_prog(struct perf_event *event) {
    struct bpf_prog_array *old_array = (struct bpf_prog_array *)0;
    struct bpf_prog_array *new_array = (struct bpf_prog_array *)0;
    int ret;

    mutex_lock(&event->child_mutex);

    if (!event->prog)
        goto unlock;

    old_array = bpf_event_rcu_dereference(event->prog_array);
    ret = bpf_prog_array_copy(old_array, event->prog, (void *)0, 0, &new_array);

    if (ret < 0) {
        bpf_prog_array_delete_safe(old_array, event->prog);
    } else {
        rcu_assign_pointer(&event->prog_array, new_array);
        bpf_prog_array_free_sleepable(old_array);
    }

    bpf_prog_put(event->prog);
    event->prog = (struct bpf_prog *)0;

unlock:
    mutex_unlock(&event->child_mutex);
}

