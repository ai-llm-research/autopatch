

typedef unsigned long long uint64_t;
typedef int bool;

struct amdgpu_bo {
    struct {
        int *bdev;
        struct {
            int start;
        } mem;
        int resource;
    } tbo;
};

struct dma_resv {};

struct dma_fence {};

struct amdgpu_device {
    struct {
        struct amdgpu_ring *buffer_funcs_ring;
    } mman;
};

struct amdgpu_ring {};

struct amdgpu_res_cursor {
    int mem_type;
    uint64_t start;
    uint64_t size;
};

int EINVAL = 22;

struct amdgpu_device* amdgpu_ttm_adev(int *bdev) {
    return (struct amdgpu_device*)0;
}

struct dma_fence* dma_fence_get_stub() {
    return (struct dma_fence*)0;
}

void amdgpu_res_first(int resource, int start, int size, struct amdgpu_res_cursor *cursor) {}

int amdgpu_bo_size(struct amdgpu_bo *bo) {
    return 0;
}

bool amdgpu_res_cleared(struct amdgpu_res_cursor *cursor) {
    return 0;
}

uint64_t amdgpu_ttm_domain_start(struct amdgpu_device *adev, int mem_type) {
    return 0;
}

int amdgpu_ttm_map_buffer(int *tbo, int resource, struct amdgpu_res_cursor *cursor,
                          int param1, struct amdgpu_ring *ring, bool param2,
                          uint64_t *size, uint64_t *addr) {
    return 0;
}

int amdgpu_ttm_fill_mem(struct amdgpu_ring *ring, int param1, uint64_t addr, uint64_t size,
                        struct dma_resv *resv, struct dma_fence **fence,
                        bool param2, bool param3) {
    return 0;
}

void amdgpu_res_next(struct amdgpu_res_cursor *cursor, uint64_t size) {}

int min(int a, int b) {
    return (a < b) ? a : b;
}

int amdgpu_ttm_clear_buffer(struct amdgpu_bo *bo, struct dma_resv *resv, struct dma_fence **fence) {
    struct amdgpu_device *adev = amdgpu_ttm_adev(bo->tbo.bdev);
    struct amdgpu_ring *ring = adev->mman.buffer_funcs_ring;
    struct amdgpu_res_cursor cursors;
    struct amdgpu_res_cursor base;
    uint64_t addr, size;
    int r;

    if (*fence || !ring)
        return -EINVAL;

    *fence = dma_fence_get_stub();

    amdgpu_res_first(bo->tbo.resource, bo->tbo.mem.start,
                amdgpu_bo_size(bo), &cursors);
    amdgpu_res_first(bo->tbo.resource, bo->tbo.mem.start,
                amdgpu_bo_size(bo), &base);

    do {
        if (!amdgpu_res_cleared(&cursors)) {
            addr = amdgpu_ttm_domain_start(adev, cursors.mem_type);
            addr += cursors.start;

            size = min(amdgpu_bo_size(bo), cursors.size);

            r = amdgpu_ttm_map_buffer((int*)&bo->tbo, bo->tbo.resource, &cursors,
                            0, ring, 0, &size, &addr);
            if (r)
                goto out;

            r = amdgpu_ttm_fill_mem(ring, 0, addr, size, resv, fence,
                             0, 0);
            if (r)
                goto out;
        }

        amdgpu_res_next(&cursors, cursors.size);
    } while ((!amdgpu_bo_size(bo) || cursors.start < amdgpu_bo_size(bo)));

    r = 0;
out:
    return r;
}

