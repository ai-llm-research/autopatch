

struct ttm_device;
struct ttm_resource;

struct amdgpu_bo {
    struct ttm_buffer_object {
        struct ttm_device *bdev;
        struct ttm_resource *mem;
    } tbo;
};

struct ttm_device {};

struct ttm_resource {};

struct dma_resv {};

struct dma_fence {};

struct amdgpu_device {
    struct mman {
        struct buffer_funcs {
            struct amdgpu_ring *ring;
            struct mutex {
                int lock; // Just a placeholder for the mutex
            } mutex;
        } *buffer_funcs;
    } mman;
};

struct amdgpu_ring {};

struct amdgpu_res_cursor {
    unsigned long long size;
    unsigned long long remaining;
};

int amdgpu_bo_size(struct amdgpu_bo *bo) {
    return 0;
}

struct amdgpu_device* amdgpu_ttm_adev(struct ttm_device* bdev) {
    return 0;
}

int amdgpu_ttm_map_buffer(struct amdgpu_bo *bo, struct ttm_resource *mem,
                          struct amdgpu_res_cursor *cursor, unsigned int window,
                          struct amdgpu_ring *ring, int a, unsigned long long *size,
                          unsigned long long *gpu_addr) {
    return 0;
}

int amdgpu_ttm_fill_mem(struct amdgpu_ring *ring, int a, unsigned long long gpu_addr,
                        unsigned long long size, struct dma_resv *resv, struct dma_fence **next,
                        int b, int c) {
    return 0;
}

void amdgpu_res_first(struct ttm_resource *mem, int a, int b,
                      struct amdgpu_res_cursor *cursor) {
    cursor->remaining = 268435456ULL;
    cursor->size = 268435456ULL;
}

int amdgpu_res_cleared(struct amdgpu_res_cursor *cursor) {
    return 0;
}

void amdgpu_res_next(struct amdgpu_res_cursor *cursor, unsigned long long size) {
    cursor->remaining -= size;
}

void mutex_lock(struct mutex *mutex) {}

void mutex_unlock(struct mutex *mutex) {}

void dma_fence_put(struct dma_fence *fence) {}

struct dma_fence* dma_fence_get_stub() {
    return 0;
}

unsigned long long min(unsigned long long a, unsigned long long b) {
    return a < b ? a : b;
}

#define EINVAL -1
#define u64 unsigned long long

int amdgpu_ttm_clear_buffer(struct amdgpu_bo *bo, struct dma_resv *resv, struct dma_fence **fence) {
    struct amdgpu_device *adev;
    struct amdgpu_ring *ring;
    struct amdgpu_res_cursor cursor;
    unsigned long long gpu_addr;
    unsigned int window = 0;
    int r = 0;

    adev = amdgpu_ttm_adev(bo->tbo.bdev);

    if (!adev->mman.buffer_funcs)
        return -EINVAL;

    ring = adev->mman.buffer_funcs->ring;

    if (!fence)
        return -EINVAL;

    *fence = dma_fence_get_stub();

    amdgpu_res_first(bo->tbo.mem, 0, amdgpu_bo_size(bo), &cursor);

    mutex_lock(&adev->mman.buffer_funcs->mutex);

    while (cursor.remaining > 0) {
        struct dma_fence *next = 0;
        u64 size;

        if (amdgpu_res_cleared(&cursor)) {
            amdgpu_res_next(&cursor, cursor.size);
            continue;
        }

        size = min(cursor.remaining, 268435456ULL);

        r = amdgpu_ttm_map_buffer(bo, bo->tbo.mem, &cursor, window, ring, 0, &size, &gpu_addr);
        if (r)
            goto err;

        r = amdgpu_ttm_fill_mem(ring, 0, gpu_addr, size, resv, &next, 0, 0);
        if (r)
            goto err;

        dma_fence_put(*fence);
        *fence = next;

        amdgpu_res_next(&cursor, size);
    }
err:
    mutex_unlock(&adev->mman.buffer_funcs->mutex);

    return r;
}

