

typedef unsigned char u8;
typedef unsigned int size_t;

enum ucode_state {
    UCODE_OK,
    UCODE_NEW
};

struct cpuinfo_x86 {
    unsigned int microcode;
};

struct ucode_patch {
    unsigned int patch_id;
};

int for_each_node(int nid) {
    // Stub implementation
    return 0;
}

unsigned int cpumask_first(int cpumask) {
    // Stub implementation
    return 0;
}

struct cpuinfo_x86 cpu_data(unsigned int cpu) {
    // Stub implementation
    struct cpuinfo_x86 dummy;
    return dummy;
}

struct ucode_patch* find_patch(unsigned int cpu) {
    // Stub implementation
    return 0;
}

enum ucode_state _load_microcode_amd(u8 family, const u8 *data, size_t size) {
    // Stub implementation
    return UCODE_OK;
}

int node_cpumask(int nid) {
    // Stub implementation
    return 0;
}

static enum ucode_state load_microcode_amd(u8 family, const u8 *data, size_t size) {
    struct cpuinfo_x86 c;
    int nid;
    unsigned int cpu;
    struct ucode_patch *patch;
    enum ucode_state ret;

    ret = _load_microcode_amd(family, data, size);

    if (ret != UCODE_OK)
        return ret;

    for (nid = 0; for_each_node(nid); ++nid) {
        cpu = cpumask_first(node_cpumask(nid));
        c = cpu_data(cpu);
        
        patch = find_patch(cpu);

        if (!patch)
            continue;

        if (c.microcode >= patch->patch_id)
            continue;

        ret = UCODE_NEW;
    }

    return ret;
}

