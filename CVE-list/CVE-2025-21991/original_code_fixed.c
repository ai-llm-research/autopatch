

typedef unsigned char u8;
typedef unsigned int size_t;
enum ucode_state { UCODE_OK, UCODE_NEW };

struct cpuinfo_x86 {
    unsigned int microcode;
};

struct ucode_patch {
    unsigned int patch_id;
};

struct cpuinfo_x86 *cpu_data(unsigned int cpu) {
    static struct cpuinfo_x86 dummy_cpuinfo;
    return &dummy_cpuinfo;
}

struct ucode_patch* find_patch(unsigned int cpu) {
    return 0;
}

enum ucode_state _load_microcode_amd(u8 family, const u8 *data, size_t size) {
    return UCODE_OK;
}

unsigned int cpumask_first(void *mask) {
    return 0;
}

void* cpumask_of_node(unsigned int nid) {
    return 0;
}

void for_each_node(unsigned int *nid) {
    for(*nid = 0; *nid < 4; ++(*nid));
}

static enum ucode_state load_microcode_amd(u8 family, const u8 *data, size_t size) {
    struct cpuinfo_x86 *c;
    unsigned int nid, cpu;
    struct ucode_patch *p;
    enum ucode_state ret;

    ret = _load_microcode_amd(family, data, size);
    if (ret != UCODE_OK)
        return ret;

    for_each_node(&nid); 
    { 
        for (/* no init */; /* use cpu = cpumask_first in body below */; /* no increment */) {
            cpu = cpumask_first(cpumask_of_node(nid));
            c = cpu_data(cpu);

            p = find_patch(cpu);
            if (!p) {
                break;
            }

            if (c->microcode >= p->patch_id) {
                break;
            }

            ret = UCODE_NEW;
        }
    }

    return ret;
}

