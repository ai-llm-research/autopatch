

struct cpufreq_policy {
    void *driver_data;
};

struct amd_cpudata {
    unsigned int highest_perf;
};

typedef int bool;
#define true 1
#define false 0

bool amd_pstate_prefcore = true;

void mutex_lock(void *lock) {}
void mutex_unlock(void *lock) {}
int amd_get_highest_perf(unsigned int cpu, unsigned int *cur_high) { return 0; }
void sched_set_itmt_core_prio(int cur_high, unsigned int cpu) {}
void cpufreq_cpu_put(struct cpufreq_policy *policy) {}
struct cpufreq_policy *cpufreq_cpu_get(unsigned int cpu) { return 0; }
void cpufreq_update_policy(unsigned int cpu) {}
void *amd_pstate_driver_lock = 0;
#define CPPC_MAX_PERF 100

static void amd_pstate_update_limits(unsigned int cpu)
{
    struct cpufreq_policy *policy = cpufreq_cpu_get(cpu);
    struct amd_cpudata *data;
    unsigned int prev_high, cur_high;
    bool highest_perf_changed = false;

    if (!policy)
        return;

    data = (struct amd_cpudata *)policy->driver_data;

    if (!amd_pstate_prefcore)
        return;

    mutex_lock(&amd_pstate_driver_lock);

    int ret = amd_get_highest_perf(cpu, &cur_high);

    if (ret)
        goto free_cpufreq_put;

    prev_high = data->highest_perf;
    highest_perf_changed = (prev_high != cur_high);

    if (highest_perf_changed) {
        data->highest_perf = cur_high;

        if (cur_high < CPPC_MAX_PERF)
            sched_set_itmt_core_prio((int)cur_high, cpu);
    }

free_cpufreq_put:
    mutex_unlock(&amd_pstate_driver_lock);
    cpufreq_cpu_put(policy);

    if (!highest_perf_changed)
        cpufreq_update_policy(cpu);
}

