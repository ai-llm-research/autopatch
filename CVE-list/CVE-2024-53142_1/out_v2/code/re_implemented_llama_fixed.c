

struct timespec {
    long tv_sec;
    long tv_nsec;
};

enum State {
    SkipIt,
    Reset,
    Start,
    CopyFile
};

int strcmp(const char *s1, const char *s2);
void free_hash();
void clean_path(char *path, int mode);
int make_links(int major, int minor, int ino, int mode, const char *collected);
int open(const char *pathname, int flags, int mode);
void fchown(int fd, int uid, int gid);
void fchmod(int fd, int mode);
int ftruncate(int fd, int length);
void mkdir(const char *pathname, int mode);
void chown(const char *pathname, int uid, int gid);
void chmod(const char *pathname, int mode);
void add_to_list(const char *pathname, long mtime);
void mknod(const char *pathname, int mode, int dev);
int makedev(int major, int minor);
void utimensat(int dirfd, const char *pathname, const struct timespec times[2], int flags);

#define O_WRONLY 0x0001
#define O_CREAT 0x0002
#define O_TRUNC 0x0004
#define O_LARGEFILE 0x0008
#define S_IFMT 0x0010
#define S_IFREG 0x0020
#define S_IFDIR 0x0040
#define S_IFBLK 0x0080
#define S_IFCHR 0x0100
#define S_IFIFO 0x0200
#define S_IFSOCK 0x0400
#define AT_FDCWD -100
#define UTIME_OMIT ((1l << 30) - 2) // This is not a real value, only a placeholder
#define AT_SYMLINK_NOFOLLOW 0x0800

char collected[] = "filename";
char TRAILER[] = "TRAILER!!!";
int mode, state, next_state, wfile, errno, uid = -1, gid = -1, blen, major, minor, ino;
long mtime;
unsigned int pos;
unsigned int cksum;

static int do_name(void) {
    state = Start;
    next_state = Reset;

    if (strcmp(collected, TRAILER) == 0) {
        free_hash();
        return 0;
    }

    clean_path(collected, mode);

    if ((mode & S_IFMT) == S_IFREG) {
        int ml = make_links(major, minor, ino, mode, collected);

        if (ml != 0) {
            int openflags = O_WRONLY | O_CREAT | O_LARGEFILE;

            if (ml > 0)
                openflags |= O_TRUNC;

            wfile = open(collected, openflags, mode);

            if (wfile < 0)
                return errno;

            pos = 0;
            cksum = 0;

            if (uid != -1 || gid != -1)
                fchown(wfile, uid, gid);

            fchmod(wfile, mode);

            if (blen != 0)
                ftruncate(wfile, blen);

            state = CopyFile;
        }
    } else if ((mode & S_IFMT) == S_IFDIR) {
        mkdir(collected, mode);

        if (uid != -1 || gid != -1)
            chown(collected, uid, gid);

        chmod(collected, mode);

        add_to_list(collected, mtime);
    } else if ((mode & S_IFMT) == S_IFBLK || (mode & S_IFMT) == S_IFCHR || (mode & S_IFMT) == S_IFIFO || (mode & S_IFMT) == S_IFSOCK) {
        if (make_links(major, minor, ino, mode, collected) == 0) {
            mknod(collected, mode, makedev(major, minor));

            if (uid != -1 || gid != -1)
                chown(collected, uid, gid);

            chmod(collected, mode);

            utimensat(AT_FDCWD, collected, (struct timespec[]){{mtime, UTIME_OMIT}}, AT_SYMLINK_NOFOLLOW);
        }
    }

    return 0;
}

