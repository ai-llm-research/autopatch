

typedef int __u8;
typedef unsigned int mode_t;
typedef int ssize_t;
typedef long long loff_t;

#define NULL ((void*)0) // Manually defining NULL since standard headers are not included

enum States { SkipIt, Reset, CopyFile };
int state, next_state;
char collected[256];
mode_t mode;
ssize_t body_length;
int user, group;
int mtime;
int dev;
void* crc32_tab;
void *crc32_table_ptr;
void* wfile;

int strcmp(const char* str1, const char* str2) { return 0; }
void free_some_resources() {}
void clean_path(char* path, mode_t mode) {}
int maybe_link() { return 0; }
void* filp_open(const char* path, int flags, mode_t mode) { return NULL; }
int IS_ERR(void* ptr) { return 0; }
int PTR_ERR(void* ptr) { return 0; }
loff_t lseek(loff_t offset, int whence, int origin) { return 0; }
void vfs_fchown(void* file, int user, int group) {}
void vfs_fchmod(void* file, mode_t mode) {}
void vfs_truncate(void* file, ssize_t length) {}
void init_mkdir(const char* path, mode_t mode) {}
void init_chown(const char* path, int user, int group, int flags) {}
void init_chmod(const char* path, mode_t mode) {}
void dir_add(const char* path, int mtime) {}
void init_mknod(const char* path, mode_t mode, int dev) {}
void do_utime(const char* path, int mtime) {}

static int do_name(void) {
    state = SkipIt;
    next_state = Reset;

    if (strcmp(collected, "TRAILER!!!") == 0) {
        free_some_resources();
        return 0;
    }

    clean_path(collected, mode);

    if ((mode & 040000) == 0100000) {
        int ml = maybe_link();

        if (ml != -1) {
            int openflags = 1 | 2 | 0100000;

            if (ml != 1)
                openflags |= 01000;

            wfile = filp_open(collected, openflags, mode);

            if (IS_ERR(wfile))
                return PTR_ERR(wfile);

            lseek(0, 0, 0);
            crc32_table_ptr = (__u8 *)&crc32_tab;

            vfs_fchown(wfile, user, group);
            vfs_fchmod(wfile, mode);

            if (body_length > 0)
                vfs_truncate(&wfile, body_length);

            state = CopyFile;
        }
    } else if ((mode & 040000) == 040000) {
        init_mkdir(collected, mode);
        init_chown(collected, user, group, 0);
        init_chmod(collected, mode);
        dir_add(collected, mtime);
    } else if (((mode & 040000) == 0060000) || ((mode & 040000) == 0020000) || ((mode & 040000) == 0010000) || ((mode & 040000) == 0140000)) {
        if (maybe_link() == 0) {
            init_mknod(collected, mode, dev);
            init_chown(collected, user, group, 0);
            init_chmod(collected, mode);
            do_utime(collected, mtime);
        }
    }

    return 0;
}

