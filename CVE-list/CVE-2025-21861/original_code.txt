```c
void migrate_device_finalize(unsigned long *src_pfns, unsigned long *dst_pfns, unsigned long npages)
{
	unsigned long i;

	for (i = 0; i < npages; i++) {
		struct folio *dst = NULL, *src = NULL;
		struct page *newpage = migrate_pfn_to_page(dst_pfns[i]);
		struct page *page = migrate_pfn_to_page(src_pfns[i]);

		if (newpage)
			dst = page_folio(newpage);

		if (!page) {
			if (dst) {
				folio_unlock(dst);
				folio_put(dst);
			}
			continue;
		}

		src = page_folio(page);

		if (!(src_pfns[i] & MIGRATE_PFN_MIGRATE) || !dst) {
			if (dst) {
				folio_unlock(dst);
				folio_put(dst);
			}
			dst = src;
		}

		remove_migration_ptes(src, dst, 0);
		folio_unlock(src);

		if (folio_is_zone_device(src))
			folio_put(src);
		else
			folio_putback_lru(src);

		if (dst != src) {
			folio_unlock(dst);
			if (folio_is_zone_device(dst))
				folio_put(dst);
			else
				folio_putback_lru(dst);
		}
	}
}
EXPORT_SYMBOL(migrate_device_finalize);
```
