

struct folio {
    // Minimal stub declaration
};

struct page {
    // Minimal stub declaration
};

unsigned long MIGRATE_PFN_MIGRATE;

#define NULL ((void*)0)

struct page *migrate_pfn_to_page(unsigned long pfn) {
    // Stub function
    return NULL;
}

struct folio *page_folio(struct page *page) {
    // Stub function
    return NULL;
}

void folio_unlock(struct folio *folio) {
    // Stub function
}

void folio_put(struct folio *folio) {
    // Stub function
}

void remove_migration_ptes(struct folio *src, struct folio *dst, int flag) {
    // Stub function
}

int folio_is_zone_device(struct folio *folio) {
    // Stub function
    return 0;
}

void folio_putback_lru(struct folio *folio) {
    // Stub function
}

void migrate_device_finalize(unsigned long *src_pfns, unsigned long *dst_pfns, unsigned long npages)
{
    unsigned long i;

    for (i = 0; i < npages; i++) {
        struct folio *dst_folio = NULL;
        struct folio *src_folio = NULL;

        struct page *dst_page = migrate_pfn_to_page(dst_pfns[i]);
        struct page *src_page = migrate_pfn_to_page(src_pfns[i]);

        if (dst_page)
            dst_folio = page_folio(dst_page);

        if (!src_page) {
            if (dst_folio) {
                folio_unlock(dst_folio);
                folio_put(dst_folio);
            }
            continue;
        }

        src_folio = page_folio(src_page);

        if (!(src_pfns[i] & MIGRATE_PFN_MIGRATE) || !dst_folio) {
            if (dst_folio) {
                folio_unlock(dst_folio);
                folio_put(dst_folio);
            }
            dst_folio = src_folio;
        }

        remove_migration_ptes(src_folio, dst_folio, 0);
        folio_unlock(src_folio);

        if (folio_is_zone_device(src_folio))
            folio_put(src_folio);
        else
            folio_putback_lru(src_folio);

        if (dst_folio != src_folio) {
            folio_unlock(dst_folio);
            if (folio_is_zone_device(dst_folio))
                folio_put(dst_folio);
            else
                folio_putback_lru(dst_folio);
        }
    }
}

void EXPORT_SYMBOL(migrate_device_finalize);

