

struct page {};
struct folio {};

#define NULL ((void*)0)

int IS_ERR(struct page *pg) { return 0; }
int PageFolio(struct page *pg) { return 0; }
int PageMigrating(struct page *pg) { return 0; }
int folio_is_zone_device(struct folio *f) { return 0; }

struct page* migrate_pfn_to_page(unsigned long pfn) { return NULL; }
struct folio* page_folio(struct page *pg) { return NULL; }
void remove_migration_ptes(struct folio *src, struct folio *dst, int arg) {}
void folio_unlock(struct folio *f) {}
void folio_put(struct folio *f) {}
void folio_putback_lru(struct folio *f) {}

void migrate_device_finalize(unsigned long *src_pfns, unsigned long *dst_pfns, unsigned long npages)
{
    unsigned long i;

    for (i = 0; i < npages; i++) {
        struct folio *dest_folio = NULL;
        struct folio *source_folio = NULL;

        struct page *dest_pg = migrate_pfn_to_page(*dst_pfns++);
        struct page *src_pg = migrate_pfn_to_page(*src_pfns++);

        if ((!IS_ERR(dest_pg)) && PageFolio(dest_pg))
            dest_folio = page_folio(dest_pg);
            
        if (IS_ERR(src_pg)) {
            if (dest_folio) {
                folio_unlock(dest_folio);
                folio_put(dest_folio);
            }
            continue;
        }

        source_folio = page_folio(src_pg);
    
        if (!PageMigrating(src_pg) || !dest_folio) {
            if (dest_folio) {
                folio_unlock(dest_folio);
                folio_put(dest_folio);
            }
            dest_folio = source_folio;
        }

        remove_migration_ptes(source_folio, dest_folio, 0);

        folio_unlock(source_folio);

        if (folio_is_zone_device(source_folio))
            folio_put(source_folio);
        else
            folio_putback_lru(source_folio);

        if (dest_folio != source_folio) {
            folio_unlock(dest_folio);
            if (folio_is_zone_device(dest_folio))
                folio_put(dest_folio);
            else
                folio_putback_lru(dest_folio);
        }
    }
}

